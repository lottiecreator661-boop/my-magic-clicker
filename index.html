<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON FINAL ELITE FIXED</title>
    <style>
        body { background: #1a1f2e; color: white; font-family: system-ui; padding: 16px; margin: 0; }
        .card { background: #2a3142; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .row { display: flex; justify-content: space-between; margin: 8px 0; }
        button { background: #4f8ef7; border: none; color: white; padding: 12px 24px; border-radius: 12px; font-size: 16px; width: 100%; margin: 4px 0; cursor: pointer; }
        input, select { background: #1a1f2e; border: 1px solid #4f8ef7; color: white; padding: 12px; border-radius: 12px; width: 100%; margin: 4px 0; box-sizing: border-box; }
        .progress { background: #1a1f2e; height: 20px; border-radius: 10px; overflow: hidden; }
        .progress-fill { background: #4f8ef7; height: 100%; width: 0%; transition: width 0.3s; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 16px 0; }
        .m-cell { background: #3a4152; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 24px; border-radius: 8px; cursor: pointer; }
        .m-cell.open-gem { background: #10b981; }
        .m-cell.open-bomb { background: #ef4444; }
        .ladder-grid { display: flex; flex-direction: column; gap: 8px; margin: 16px 0; }
        .ladder-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .ladder-row.locked { opacity: 0.5; pointer-events: none; }
        .l-cell { background: #3a4152; padding: 16px; text-align: center; font-size: 24px; border-radius: 8px; cursor: pointer; }
        .hidden { display: none; }
        .vip-badge { background: gold; color: black; padding: 4px 8px; border-radius: 20px; font-size: 12px; }
        #energy-timer { font-size: 12px; color: #8e9ab0; }
    </style>
</head>
<body>
    <div class="card">
        <div class="row">
            <span>üí∞ TON: <span id="balance">0</span></span>
            <span>‚ö°Ô∏è <span id="energy">0</span>/<span id="max-energy">250</span></span>
        </div>
        <div class="progress">
            <div class="progress-fill" id="nrg-bar"></div>
        </div>
        <div id="energy-timer" class="row">–ó–∞—Ä—è–∂–µ–Ω–æ –Ω–∞ 100%</div>
        <div class="row">
            <span>üìà PPS: <span id="pps">0</span></span>
            <button onclick="claimDaily()" style="width: auto; padding: 8px 16px;">üéÅ Daily</button>
        </div>
    </div>

    <!-- –£–ª—É—á—à–µ–Ω–∏—è -->
    <div class="card">
        <h3>üè™ –ú–∞–≥–∞–∑–∏–Ω</h3>
        <button onclick="buyM(1, 10, 0.1)">üíé –ú–∞–ª–µ–Ω—å–∫–∏–π –±–æ–Ω—É—Å (10 TON) +0.1 PPS</button>
        <button onclick="buyM(2, 50, 0.6)">üíé –°—Ä–µ–¥–Ω–∏–π –±–æ–Ω—É—Å (50 TON) +0.6 PPS</button>
        <button onclick="buyM(3, 200, 3)">üíé –ë–æ–ª—å—à–æ–π –±–æ–Ω—É—Å (200 TON) +3 PPS</button>
        <button onclick="buyVIP()">üëë VIP (500 TON) +10000 —ç–Ω–µ—Ä–≥–∏–∏</button>
    </div>

    <!-- –ú–∏–Ω—ã -->
    <div class="card">
        <h3>üí£ –ú–ò–ù–´</h3>
        <input type="number" id="mb" placeholder="–°—Ç–∞–≤–∫–∞" value="10">
        <select id="mc">
            <option value="3">3 –º–∏–Ω—ã (x2.0)</option>
            <option value="4">4 –º–∏–Ω—ã (x2.5)</option>
            <option value="5">5 –º–∏–Ω (x3.0)</option>
        </select>
        <button onclick="startM()">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        <div id="m-grid" class="grid"></div>
        <div id="g-info" class="row"></div>
        <button id="btn-cashout" class="hidden" onclick="doCashout()">üí∞ –ó–∞–±—Ä–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à</button>
    </div>

    <!-- –õ–µ—Å—Ç–Ω–∏—Ü–∞ -->
    <div class="card">
        <h3>ü™ú –õ–ï–°–¢–ù–ò–¶–ê (x2.1 –∑–∞ —à–∞–≥)</h3>
        <input type="number" id="lb" placeholder="–°—Ç–∞–≤–∫–∞" value="10">
        <button onclick="startL()">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å</button>
        <div id="l-grid" class="ladder-grid"></div>
        <div id="l-info" class="row"></div>
        <button id="l-cashout" class="hidden" onclick="doCashout()">üí∞ –ó–∞–±—Ä–∞—Ç—å</button>
    </div>

    <!-- –ö–æ–ª–µ—Å–æ -->
    <div class="card">
        <h3>üé° –ö–û–õ–ï–°–û (–æ–±—â–∏–π –±–∞–Ω–∫)</h3>
        <input type="number" id="wb" placeholder="–°—Ç–∞–≤–∫–∞" value="10">
        <button onclick="betWheel()">üé≤ –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
        <div id="w-pot" class="row">–û–±—â–∏–π –±–∞–Ω–∫: 0 TON</div>
        <div id="w-players" class="row">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 0</div>
    </div>

    <script>
        (function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
            let tg = window.Telegram?.WebApp;
            if (tg) tg.expand();
            let userId = tg?.initDataUnsafe?.user?.id || 0;

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            let pot = 0; // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –æ–±—ä—è–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
            let wheelPlayers = 0;
            
            // –§—É–Ω–∫—Ü–∏—è –≥–ª—É–±–æ–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —á–∏—Å–ª–æ
            function n(val, fallback = 0) {
                if (val === null || val === undefined || val === '') return fallback;
                let num = parseFloat(val);
                return isNaN(num) || !isFinite(num) ? fallback : num;
            }

            let today = new Date().toLocaleDateString();
            let saved = (() => {
                try {
                    return JSON.parse(localStorage.getItem('ton_final_elite')) || {};
                } catch {
                    return {};
                }
            })();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            let db = {
                bal: n(saved.bal, 50),
                nrg: n(saved.nrg, 250),
                pps: n(saved.pps, 0),
                clk: n(saved.clk, 0),
                last: n(saved.last, Date.now()),
                vip: saved.vip || false,
                daily: n(saved.daily, 0),
                q_date: saved.q_date || today,
                q_list: saved.q_list || [false, false, false, false, false]
            };

            // –°–±—Ä–æ—Å –∫–≤–µ—Å—Ç–æ–≤ –Ω–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å
            if(db.q_date !== today) {
                db.q_list = [false, false, false, false, false];
                db.q_date = today;
            }

            // –¢–µ–∫—É—â–∞—è –∏–≥—Ä–∞
            let cur = { active: false, bet: 0, mult: 1, type: '', data: null, step: 0 };
            
            // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            function save() { 
                try {
                    db.bal = n(db.bal, 0);
                    db.nrg = Math.min(db.vip ? 10000 : 250, Math.max(0, n(db.nrg)));
                    localStorage.setItem('ton_final_elite', JSON.stringify(db)); 
                } catch (e) {
                    console.error('Save error:', e);
                }
            }

            // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –∫–≤–µ—Å—Ç–æ–≤ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
            function renderQuests() {
                // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∫–≤–µ—Å—Ç–æ–≤, –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
                console.log('Quests updated:', db.q_list);
            }

            // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –∏–≥—Ä—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
            function closeG() {
                cur.active = false;
                // –û—á–∏—â–∞–µ–º –∏–≥—Ä–æ–≤—ã–µ —Å–µ—Ç–∫–∏
                document.getElementById('m-grid').innerHTML = '';
                document.getElementById('l-grid').innerHTML = '';
                document.getElementById('btn-cashout')?.classList.add('hidden');
                document.getElementById('l-cashout')?.classList.add('hidden');
                document.getElementById('g-info').innerText = '';
                document.getElementById('l-info').innerText = '';
            }

            // –û—Å–Ω–æ–≤–Ω–æ–π –∞–ø–¥–µ–π—Ç
            function update() {
                try {
                    let now = Date.now();
                    let dt = Math.max(0, (now - db.last) / 1000);
                    
                    // –ù–∞—á–∏—Å–ª—è–µ–º –ø–∞—Å—Å–∏–≤–∫—É (–Ω–µ –±–æ–ª—å—à–µ 100 –∑–∞ —Ä–∞–∑)
                    let passiveGain = Math.min(100, n(db.pps) * dt);
                    db.bal = n(db.bal + passiveGain);
                    
                    let maxN = db.vip ? 10000 : 250;
                    let reg = db.vip ? 1.0 : 0.25;
                    
                    if(db.nrg < maxN) {
                        db.nrg = Math.min(maxN, db.nrg + (dt * reg));
                        let remain = (maxN - db.nrg) / reg;
                        if(remain > 0 && isFinite(remain)) {
                            let m = Math.floor(remain / 60);
                            let s = Math.floor(remain % 60);
                            document.getElementById('energy-timer').innerText = `–§—É–ª–ª —ç–Ω–µ—Ä–≥–∏—è —á–µ—Ä–µ–∑: ${m}:${s < 10 ? '0'+s : s}`;
                        }
                    } else {
                        document.getElementById('energy-timer').innerText = "‚ö° –ó–∞—Ä—è–∂–µ–Ω–æ –Ω–∞ 100%";
                    }

                    db.last = now;
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                    document.getElementById('balance').innerText = n(db.bal).toFixed(2);
                    document.getElementById('pps').innerText = n(db.pps).toFixed(2);
                    document.getElementById('energy').innerText = Math.floor(n(db.nrg));
                    document.getElementById('max-energy').innerText = maxN;
                    document.getElementById('nrg-bar').style.width = (n(db.nrg)/maxN*100)+'%';
                    
                    renderQuests();
                    save();
                } catch (e) {
                    console.error('Update error:', e);
                }
            }

            // --- –ò–ì–†–´ ---
            function startM() {
                try {
                    let input = document.getElementById('mb').value;
                    let b = n(input, 0);
                    let c = parseInt(document.getElementById('mc').value) || 3;

                    if (b <= 0) return alert("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É!");
                    if (b > db.bal) return alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞!");
                    if (b > 10000000) return alert("‚ùå –ú–∞–∫—Å. —Å—Ç–∞–≤–∫–∞ 10,000,000!");

                    db.bal -= b;
                    cur = { active: true, bet: b, mult: 1, type: 'mines', data: Array(25).fill(false), step: 0 };
                    
                    // –†–∞—Å—Å—Ç–∞–≤–ª—è–µ–º –º–∏–Ω—ã
                    let p = 0;
                    while(p < c) {
                        let r = Math.floor(Math.random() * 25);
                        if(!cur.data[r]) {
                            cur.data[r] = true;
                            p++;
                        }
                    }
                    
                    let grid = document.getElementById('m-grid');
                    grid.innerHTML = '';
                    for(let i = 0; i < 25; i++) {
                        let d = document.createElement('div');
                        d.className = 'm-cell';
                        d.innerText = '?';
                        d.onclick = (idx => () => {
                            if(!cur.active || d.innerText !== '?') return;
                            if(cur.data[idx]) { 
                                d.innerText = 'üí£';
                                d.classList.add('open-bomb');
                                cur.active = false;
                                document.getElementById('btn-cashout').classList.add('hidden');
                                document.getElementById('g-info').innerText = "üí• –í–ó–†–´–í! –ü–æ—Ç–µ—Ä—è–Ω–æ: " + cur.bet.toFixed(2);
                                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ —è—á–µ–π–∫–∏
                                document.querySelectorAll('.m-cell').forEach(cell => cell.style.pointerEvents = 'none');
                            } else { 
                                d.innerText = 'üíé';
                                d.classList.add('open-gem');
                                cur.mult += (c/4) + 0.3;
                                let win = cur.bet * cur.mult;
                                document.getElementById('g-info').innerText = `üíé –ö—É—à: ${win.toFixed(2)} TON`;
                                document.getElementById('btn-cashout').classList.remove('hidden');
                            }
                        })(i);
                        grid.appendChild(d);
                    }
                    update();
                } catch (e) {
                    console.error('Mines error:', e);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã');
                }
            }

            function startL() {
                try {
                    let input = document.getElementById('lb').value;
                    let b = n(input, 0);

                    if (b <= 0) return alert("‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É!");
                    if (b > db.bal) return alert("‚ùå –ú–∞–ª–æ TON!");
                    if (b > 10000000) return alert("‚ùå –ú–∞–∫—Å. —Å—Ç–∞–≤–∫–∞ 10,000,000!");

                    db.bal -= b;
                    cur = { active: true, bet: b, mult: 1, type: 'ladder', step: 0 };
                    
                    let grid = document.getElementById('l-grid');
                    grid.innerHTML = '';
                    for(let i = 0; i < 6; i++) {
                        let r = document.createElement('div');
                        r.className = 'ladder-row' + (i > 0 ? ' locked' : '');
                        let t = Math.floor(Math.random() * 2); // 0 –∏–ª–∏ 1
                        r.innerHTML = `<div class="l-cell" data-row="${i}" data-choice="0">?</div><div class="l-cell" data-row="${i}" data-choice="1">?</div>`;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                        let cells = r.children;
                        for(let j = 0; j < cells.length; j++) {
                            cells[j].onclick = (function(row, choice, target) {
                                return function() {
                                    stepL(choice, t, row, target);
                                };
                            })(i, j, cells[j]);
                        }
                        grid.appendChild(r);
                    }
                    update();
                } catch (e) {
                    console.error('Ladder error:', e);
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã');
                }
            }

            function stepL(ch, tr, idx, el) {
                try {
                    if(!cur.active || idx !== cur.step) return;
                    
                    if(ch === tr) { 
                        el.innerText = 'üí•';
                        el.style.background = '#ef4444';
                        cur.active = false;
                        document.getElementById('l-cashout').classList.add('hidden');
                        document.getElementById('l-info').innerText = "üí• –£–ü–ê–õ! –ü–æ—Ç–µ—Ä—è–Ω–æ: " + cur.bet.toFixed(2);
                        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ
                        document.querySelectorAll('.l-cell').forEach(cell => cell.style.pointerEvents = 'none');
                    } else { 
                        el.innerText = 'üíé';
                        el.style.background = '#10b981';
                        cur.mult *= 2.1;
                        cur.step++;
                        let win = cur.bet * cur.mult;
                        document.getElementById('l-info').innerText = `üíé –í—ã–ø–ª–∞—Ç–∞: ${win.toFixed(2)} TON`;
                        document.getElementById('l-cashout').classList.remove('hidden');
                        
                        if(cur.step < 6) {
                            document.querySelectorAll('.ladder-row')[cur.step].classList.remove('locked');
                        } else {
                            // –ü–æ–±–µ–¥–∞ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
                            document.getElementById('l-info').innerText = `üèÜ –ú–ê–ö–°–ò–ú–£–ú! ${win.toFixed(2)} TON`;
                        }
                    }
                } catch (e) {
                    console.error('Step error:', e);
                }
            }

            function betWheel() {
                try {
                    let input = document.getElementById('wb').value;
                    let b = n(input, 0);
                    if(b < 1 || b > 1000000) return alert("‚ùå –°—Ç–∞–≤–∫–∞ –æ—Ç 1 –¥–æ 1,000,000!");
                    if(b > db.bal) return alert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON!");
                    
                    db.bal -= b;
                    pot = n(pot + b); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: pot –æ–±—ä—è–≤–ª–µ–Ω–∞
                    wheelPlayers++;
                    
                    document.getElementById('w-pot').innerText = `üéØ –û–±—â–∏–π –±–∞–Ω–∫: ${pot.toFixed(2)} TON`;
                    document.getElementById('w-players').innerText = `üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${wheelPlayers}`;
                    
                    // –° –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 10% –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–ª–µ—Å–æ (–¥–ª—è –¥–µ–º–æ)
                    if(Math.random() < 0.1) {
                        setTimeout(() => {
                            if(wheelPlayers > 0) {
                                let winner = Math.random() < 0.3; // 30% —à–∞–Ω—Å –≤—ã–∏–≥—Ä—ã—à–∞
                                if(winner) {
                                    db.bal += pot;
                                    alert(`üéâ –í–´ –í–´–ò–ì–†–ê–õ–ò –ö–û–õ–ï–°–û! +${pot.toFixed(2)} TON`);
                                } else {
                                    alert(`üò¢ –í—ã –Ω–µ –≤—ã–∏–≥—Ä–∞–ª–∏. –ë–∞–Ω–∫: ${pot.toFixed(2)} TON —É—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ`);
                                }
                                pot = 0;
                                wheelPlayers = 0;
                                document.getElementById('w-pot').innerText = 'üéØ –û–±—â–∏–π –±–∞–Ω–∫: 0 TON';
                                document.getElementById('w-players').innerText = 'üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 0';
                                update();
                            }
                        }, 3000);
                    }
                    update();
                } catch (e) {
                    console.error('Wheel error:', e);
                }
            }

            function doCashout() {
                try {
                    if(!cur.active) return;
                    
                    let win = n(cur.bet * cur.mult);
                    db.bal = n(db.bal + win);
                    cur.active = false;
                    alert("üéâ –ü–æ–±–µ–¥–∞! –ó–∞—á–∏—Å–ª–µ–Ω–æ: " + win.toFixed(2) + " TON");
                    closeG(); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
                    update();
                } catch (e) {
                    console.error('Cashout error:', e);
                }
            }

            // –ú–∞–≥–∞–∑–∏–Ω
            function buyM(id, cost, p) {
                try {
                    if(db.bal >= cost) { 
                        db.bal -= cost; 
                        db.pps = n(db.pps + p); 
                        update(); 
                        alert("‚úÖ –£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ! +" + p + " PPS"); 
                    } else {
                        alert("‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç TON! –ù—É–∂–Ω–æ: " + cost);
                    }
                } catch (e) {
                    console.error('Buy error:', e);
                }
            }

            function buyVIP() {
                try {
                    if(db.bal >= 500) {
                        db.bal -= 500;
                        db.vip = true;
                        db.nrg = Math.min(10000, db.nrg);
                        update();
                        alert("üëë VIP –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! +10000 —ç–Ω–µ—Ä–≥–∏–∏");
                    } else {
                        alert("‚ùå –ù—É–∂–Ω–æ 500 TON –¥–ª—è VIP");
                    }
                } catch (e) {
                    console.error('VIP error:', e);
                }
            }

            function claimDaily() {
                try {
                    if(Date.now() - db.daily > 86400000) { 
                        db.bal += 15; 
                        db.daily = Date.now(); 
                        alert("üéÅ –ë–æ–Ω—É—Å 15 TON –ø–æ–ª—É—á–µ–Ω!"); 
                        update();
                    } else {
                        let remain = 86400000 - (Date.now() - db.daily);
                        let hours = Math.floor(remain / 3600000);
                        let mins = Math.floor((remain % 3600000) / 60000);
                        alert(`‚è∞ –ë–æ–Ω—É—Å —á–µ—Ä–µ–∑ ${hours}—á ${mins}–º`);
                    }
                } catch (e) {
                    console.error('Daily error:', e);
                }
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å—Ç–∞—Ä—Ç
            window.n = n;
            window.startM = startM;
            window.startL = startL;
            window.stepL = stepL;
            window.betWheel = betWheel;
            window.doCashout = doCashout;
            window.buyM = buyM;
            window.buyVIP = buyVIP;
            window.claimDaily = claimDaily;
            window.closeG = closeG;

            // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
            setInterval(update, 1000);
            update();

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–∫–µ—Ä –Ω–∞ –±–∞–ª–∞–Ω—Å
            document.getElementById('balance').addEventListener('dblclick', function() {
                if(db.nrg >= 1) {
                    db.nrg -= 1;
                    db.bal += 0.01;
                    db.clk++;
                    update();
                }
            });
        })();
    </script>
</body>
</html>
