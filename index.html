<script>
    // –î–æ–∂–∏–¥–∞–µ–º—Å—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM, —á—Ç–æ–±—ã –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
    document.addEventListener('DOMContentLoaded', function() {
        // --- –ó–ê–©–ò–¢–ê –û–¢ –û–¢–°–£–¢–°–¢–í–ò–Ø TELEGRAM ---
        let tg;
        try {
            tg = window.Telegram?.WebApp; // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ ‚Äì –Ω–µ —É–ø–∞–¥—ë—Ç, –µ—Å–ª–∏ Telegram undefined
        } catch (e) {
            tg = null;
        }
        // –ï—Å–ª–∏ —Ç–µ–ª–µ–≥—Ä–∞–º–∞ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ–º –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        if (!tg) console.warn('Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');

        // --- –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó STORAGE ---
        let saved = {};
        try {
            saved = JSON.parse(localStorage.getItem('ton_final_elite')) || {};
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ localStorage, –Ω–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞');
            saved = {};
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ï–†–ï–ú–ï–ù–ù–´–• ---
        let userId = tg?.initDataUnsafe?.user?.id || 0;
        let pot = 0; // –æ–±—ä—è–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

        // –§—É–Ω–∫—Ü–∏—è –≥–ª—É–±–æ–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —á–∏—Å–ª–æ
        function n(val, fallback = 0) {
            let num = parseFloat(val);
            return isNaN(num) || !isFinite(num) ? fallback : num;
        }

        let today = new Date().toLocaleDateString();

        let db = {
            bal: n(saved.bal, 50),
            nrg: n(saved.nrg, 250),
            pps: n(saved.pps, 0),
            clk: n(saved.clk, 0),
            last: n(saved.last, Date.now()),
            vip: saved.vip || false,
            daily: n(saved.daily, 0),
            q_date: saved.q_date || today,
            q_list: saved.q_list || [false, false, false, false, false]
        };

        if (db.q_date !== today) {
            db.q_list = [false, false, false, false, false];
            db.q_date = today;
        }

        let cur = { active: false, bet: 0, mult: 1, type: '', data: null, step: 0 };
        let wheelSec = 30;

        // --- –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø ---
        function save() {
            db.bal = n(db.bal, 0);
            localStorage.setItem('ton_final_elite', JSON.stringify(db));
        }

        // --- –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê (—Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–∞—è) ---
        function update() {
            let now = Date.now();
            let dt = Math.max(0, (now - db.last) / 1000);

            // –ù–∞—á–∏—Å–ª—è–µ–º –ø–∞—Å—Å–∏–≤–∫—É
            db.bal = n(db.bal + (n(db.pps) * dt));

            let maxN = db.vip ? 10000 : 250;
            let reg = db.vip ? 1.0 : 0.25;

            // –û–±–Ω–æ–≤–ª—è–µ–º —ç–Ω–µ—Ä–≥–∏—é –∏ —Ç–∞–π–º–µ—Ä
            if (db.nrg < maxN) {
                db.nrg = Math.min(maxN, db.nrg + (dt * reg));
                let remain = (maxN - db.nrg) / reg;
                let m = Math.floor(remain / 60);
                let s = Math.floor(remain % 60);
                setElementText('energy-timer', `–§—É–ª–ª —ç–Ω–µ—Ä–≥–∏—è —á–µ—Ä–µ–∑: ${m}:${s < 10 ? '0' + s : s}`);
            } else {
                setElementText('energy-timer', '–ó–∞—Ä—è–∂–µ–Ω–æ –Ω–∞ 100%');
            }

            db.last = now;

            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            setElementText('balance', n(db.bal).toFixed(2));
            setElementText('pps', n(db.pps).toFixed(2));
            setElementText('energy', Math.floor(n(db.nrg)));

            let nrgBar = document.getElementById('nrg-bar');
            if (nrgBar) nrgBar.style.width = (n(db.nrg) / maxN * 100) + '%';

            renderQuests(); // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–æ–∂–µ –±–µ–∑–æ–ø–∞—Å–Ω–∞
            save();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞
        function setElementText(id, text) {
            let el = document.getElementById(id);
            if (el) el.innerText = text;
        }

        // --- –ò–ì–†–´ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã) ---

        function startM() {
            let input = document.getElementById('mb');
            if (!input) return alert('–ü–æ–ª–µ —Å—Ç–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            let b = n(input.value, 0);
            let cInput = document.getElementById('mc');
            let c = cInput ? n(cInput.value, 0) : 0;

            if (b <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É!");
            if (b > db.bal) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞!");
            if (b > 10000000) return alert("–ú–∞–∫—Å. —Å—Ç–∞–≤–∫–∞ 10,000,000!");
            if (c <= 0) return alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω (–æ—Ç 1 –¥–æ 24)");

            db.bal -= b;
            cur = { active: true, bet: b, mult: 1, type: 'mines', data: Array(25).fill(false) };
            let p = 0;
            while (p < c) {
                let r = Math.floor(Math.random() * 25);
                if (!cur.data[r]) {
                    cur.data[r] = true;
                    p++;
                }
            }

            let grid = document.getElementById('m-grid');
            if (!grid) return alert('–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            grid.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                let d = document.createElement('div');
                d.className = 'm-cell';
                d.innerText = '?';
                d.onclick = () => {
                    if (!cur.active || d.innerText !== '?') return;
                    if (cur.data[i]) {
                        d.innerText = 'üí£';
                        d.classList.add('open-bomb');
                        cur.active = false;
                        setElementText('btn-cashout', 'none'); // —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                        document.getElementById('btn-cashout').style.display = 'none';
                        setElementText('g-info', "–í–ó–†–´–í! –ü–æ—Ç–µ—Ä—è–Ω–æ: " + cur.bet.toFixed(2));
                    } else {
                        d.innerText = 'üíé';
                        d.classList.add('open-gem');
                        cur.mult += (c / 4) + 0.3;
                        setElementText('g-info', `–ö—É—à: ${(cur.bet * cur.mult).toFixed(2)} TON`);
                        let btn = document.getElementById('btn-cashout');
                        if (btn) btn.style.display = 'block';
                    }
                };
                grid.appendChild(d);
            }
            update();
        }

        function startL() {
            let input = document.getElementById('lb');
            if (!input) return alert('–ü–æ–ª–µ —Å—Ç–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            let b = n(input.value, 0);

            if (b <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É!");
            if (b > db.bal) return alert("–ú–∞–ª–æ TON!");
            if (b > 10000000) return alert("–ú–∞–∫—Å. —Å—Ç–∞–≤–∫–∞ 10,000,000!");

            db.bal -= b;
            cur = { active: true, bet: b, mult: 1, type: 'ladder', step: 0 };
            let grid = document.getElementById('l-grid');
            if (!grid) return alert('–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            grid.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                let r = document.createElement('div');
                r.className = 'ladder-row' + (i > 0 ? ' locked' : '');
                let t = Math.floor(Math.random() * 2);
                r.innerHTML = `<div class="l-cell" onclick="stepL(0,${t},${i},this)">?</div><div class="l-cell" onclick="stepL(1,${t},${i},this)">?</div>`;
                grid.appendChild(r);
            }
            update();
        }

        window.stepL = function(ch, tr, idx, el) {
            if (!cur.active || idx !== cur.step) return;
            if (ch === tr) {
                el.innerText = 'üí•';
                el.style.background = '#ef4444';
                cur.active = false;
                setElementText('btn-cashout', 'none');
                document.getElementById('btn-cashout').style.display = 'none';
                setElementText('g-info', "–£–ü–ê–õ!");
            } else {
                el.innerText = 'üíé';
                el.style.background = '#10b981';
                cur.mult *= 2.1;
                cur.step++;
                setElementText('g-info', `–í—ã–ø–ª–∞—Ç–∞: ${(cur.bet * cur.mult).toFixed(2)}`);
                let btn = document.getElementById('btn-cashout');
                if (btn) btn.style.display = 'block';
                if (cur.step < 6) {
                    let rows = document.querySelectorAll('.ladder-row');
                    if (rows[cur.step]) rows[cur.step].classList.remove('locked');
                }
            }
        };

        function betWheel() {
            let input = document.getElementById('wb');
            if (!input) return alert('–ü–æ–ª–µ —Å—Ç–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            let b = n(input.value, 0);
            if (b < 1 || b > 1000000) return alert("–°—Ç–∞–≤–∫–∞ –æ—Ç 1 –¥–æ 1,000,000!");
            if (b > db.bal) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON!");

            db.bal -= b;
            pot = n(pot + b);
            setElementText('w-pot', `–û–±—â–∏–π –±–∞–Ω–∫: ${pot.toFixed(2)} TON`);
            setElementText('w-players', "–í—ã –≤ –∏–≥—Ä–µ! –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...");
            update();
        }

        function doCashout() {
            if (!cur.active) return;
            let win = n(cur.bet * cur.mult);
            db.bal = n(db.bal + win);
            cur.active = false;
            alert("–ü–æ–±–µ–¥–∞! –ó–∞—á–∏—Å–ª–µ–Ω–æ: " + win.toFixed(2) + " TON");
            closeG(); // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            update();
        }

        // --- –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function buyM(id, cost, p) {
            if (db.bal >= cost) {
                db.bal -= cost;
                db.pps = n(db.pps + p);
                update();
                alert("–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ!");
            } else {
                alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç TON!");
            }
        }

        function claimDaily() {
            if (Date.now() - db.daily > 86400000) {
                db.bal += 15;
                db.daily = Date.now();
                alert("–ë–æ–Ω—É—Å 15 TON –ø–æ–ª—É—á–µ–Ω!");
            } else {
                alert("–ë–æ–Ω—É—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞!");
            }
            update();
        }

        // –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è renderQuests –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, —Å–æ–∑–¥–∞–¥–∏–º –∑–∞–≥–ª—É—à–∫—É
        if (typeof renderQuests !== 'function') {
            window.renderQuests = function() {
                // –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–≤–µ—Å—Ç–æ–≤
                console.log('renderQuests –≤—ã–∑–≤–∞–Ω–∞ (–∑–∞–≥–ª—É—à–∫–∞)');
            };
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
        update();
        setInterval(update, 1000);
    });
</script>
