<script>
    let tg = window.Telegram.WebApp;
    let userId = tg.initDataUnsafe?.user?.id || 0;
    
    // –§—É–Ω–∫—Ü–∏—è –≥–ª—É–±–æ–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —á–∏—Å–ª–æ
    function n(val, fallback = 0) {
        let num = parseFloat(val);
        return isNaN(num) || !isFinite(num) ? fallback : num;
    }

    let today = new Date().toLocaleDateString();
    let saved = JSON.parse(localStorage.getItem('ton_final_elite')) || {};
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    let db = {
        bal: n(saved.bal, 50),
        nrg: n(saved.nrg, 250),
        pps: n(saved.pps, 0),
        clk: n(saved.clk, 0),
        last: n(saved.last, Date.now()),
        vip: saved.vip || false,
        daily: n(saved.daily, 0),
        q_date: saved.q_date || today,
        q_list: saved.q_list || [false, false, false, false, false]
    };

    if(db.q_date !== today) {
        db.q_list = [false, false, false, false, false];
        db.q_date = today;
    }

    let cur = { active: false, bet: 0, mult: 1, type: '', data: null, step: 0 };
    let wheelSec = 30;

    function save() { 
        // –ü–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –µ—â–µ —Ä–∞–∑ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
        db.bal = n(db.bal, 0);
        localStorage.setItem('ton_final_elite', JSON.stringify(db)); 
    }

    function update() {
        let now = Date.now();
        let dt = Math.max(0, (now - db.last) / 1000);
        
        // –ù–∞—á–∏—Å–ª—è–µ–º –ø–∞—Å—Å–∏–≤–∫—É
        db.bal = n(db.bal + (n(db.pps) * dt));
        
        let maxN = db.vip ? 10000 : 250;
        let reg = db.vip ? 1.0 : 0.25;
        
        if(db.nrg < maxN) {
            db.nrg = Math.min(maxN, db.nrg + (dt * reg));
            let remain = (maxN - db.nrg) / reg;
            let m = Math.floor(remain / 60);
            let s = Math.floor(remain % 60);
            document.getElementById('energy-timer').innerText = `–§—É–ª–ª —ç–Ω–µ—Ä–≥–∏—è —á–µ—Ä–µ–∑: ${m}:${s < 10 ? '0'+s : s}`;
        } else {
            document.getElementById('energy-timer').innerText = "–ó–∞—Ä—è–∂–µ–Ω–æ –Ω–∞ 100%";
        }

        db.last = now;
        
        // –ñ–µ—Å—Ç–∫–∏–π —Ñ–∏–∫—Å –≤—ã–≤–æ–¥–∞ –±–∞–ª–∞–Ω—Å–∞
        document.getElementById('balance').innerText = n(db.bal).toFixed(2);
        document.getElementById('pps').innerText = n(db.pps).toFixed(2);
        document.getElementById('energy').innerText = Math.floor(n(db.nrg));
        document.getElementById('nrg-bar').style.width = (n(db.nrg)/maxN*100)+'%';
        
        renderQuests();
        save();
    }

    // --- –ò–ì–†–´ –° –ó–ê–©–ò–¢–û–ô –û–¢ NaN ---

    function startM() {
        let input = document.getElementById('mb').value;
        let b = n(input, 0); // –ï—Å–ª–∏ –≤–≤–µ–ª–∏ –¥–∏—á—å, –±—É–¥–µ—Ç 0
        let c = parseInt(document.getElementById('mc').value);

        if (b <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É!");
        if (b > db.bal) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞!");
        if (b > 10000000) return alert("–ú–∞–∫—Å. —Å—Ç–∞–≤–∫–∞ 10,000,000!");

        db.bal -= b;
        cur = { active: true, bet: b, mult: 1, type: 'mines', data: Array(25).fill(false) };
        let p=0; while(p<c){let r=Math.floor(Math.random()*25); if(!cur.data[r]){cur.data[r]=true; p++;}}
        
        let grid = document.getElementById('m-grid'); grid.innerHTML = '';
        for(let i=0; i<25; i++) {
            let d = document.createElement('div'); d.className = 'm-cell'; d.innerText = '?';
            d.onclick = () => {
                if(!cur.active || d.innerText !== '?') return;
                if(cur.data[i]) { 
                    d.innerText = 'üí£'; d.classList.add('open-bomb'); cur.active = false; 
                    document.getElementById('btn-cashout').style.display = 'none';
                    document.getElementById('g-info').innerText = "–í–ó–†–´–í! –ü–æ—Ç–µ—Ä—è–Ω–æ: " + cur.bet.toFixed(2);
                }
                else { 
                    d.innerText = 'üíé'; d.classList.add('open-gem'); 
                    cur.mult += (c/4)+0.3; 
                    document.getElementById('g-info').innerText = `–ö—É—à: ${(cur.bet*cur.mult).toFixed(2)} TON`; 
                    document.getElementById('btn-cashout').style.display = 'block'; 
                }
            }; grid.appendChild(d);
        }
        update();
    }

    function startL() {
        let input = document.getElementById('lb').value;
        let b = n(input, 0);

        if (b <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É!");
        if (b > db.bal) return alert("–ú–∞–ª–æ TON!");
        if (b > 10000000) return alert("–ú–∞–∫—Å. —Å—Ç–∞–≤–∫–∞ 10,000,000!");

        db.bal -= b;
        cur = { active: true, bet: b, mult: 1, type: 'ladder', step: 0 };
        let grid = document.getElementById('l-grid'); grid.innerHTML = '';
        for(let i=0; i<6; i++) {
            let r = document.createElement('div'); r.className = 'ladder-row' + (i>0?' locked':'');
            let t = Math.floor(Math.random()*2);
            r.innerHTML = `<div class="l-cell" onclick="stepL(0,${t},${i},this)">?</div><div class="l-cell" onclick="stepL(1,${t},${i},this)">?</div>`;
            grid.appendChild(r);
        }
        update();
    }

    function stepL(ch, tr, idx, el) {
        if(!cur.active || idx !== cur.step) return;
        if(ch === tr) { 
            el.innerText = 'üí•'; el.style.background = '#ef4444'; cur.active = false; 
            document.getElementById('btn-cashout').style.display = 'none';
            document.getElementById('g-info').innerText = "–£–ü–ê–õ!";
        }
        else { 
            el.innerText = 'üíé'; el.style.background = '#10b981'; 
            cur.mult *= 2.1; cur.step++; 
            document.getElementById('g-info').innerText = `–í—ã–ø–ª–∞—Ç–∞: ${(cur.bet * cur.mult).toFixed(2)}`;
            document.getElementById('btn-cashout').style.display = 'block'; 
            if(cur.step < 6) document.querySelectorAll('.ladder-row')[cur.step].classList.remove('locked'); 
        }
    }

    function betWheel() {
        let input = document.getElementById('wb').value;
        let b = n(input, 0);
        if(b < 1 || b > 1000000) return alert("–°—Ç–∞–≤–∫–∞ –æ—Ç 1 –¥–æ 1,000,000!");
        if(b > db.bal) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON!");
        
        db.bal -= b; 
        pot = n(pot + b);
        document.getElementById('w-pot').innerText = `–û–±—â–∏–π –±–∞–Ω–∫: ${pot.toFixed(2)} TON`;
        document.getElementById('w-players').innerText = "–í—ã –≤ –∏–≥—Ä–µ! –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞...";
        update();
    }

    function doCashout() { 
        if(!cur.active) return; 
        let win = n(cur.bet * cur.mult);
        db.bal = n(db.bal + win); 
        cur.active = false; 
        alert("–ü–æ–±–µ–¥–∞! –ó–∞—á–∏—Å–ª–µ–Ω–æ: " + win.toFixed(2) + " TON");
        closeG(); 
        update(); 
    }

    // --- –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function buyM(id, cost, p) { 
        if(db.bal >= cost){ 
            db.bal -= cost; 
            db.pps = n(db.pps + p); 
            update(); 
            alert("–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ!"); 
        } else {
            alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç TON!");
        }
    }

    function claimDaily() { 
        if(Date.now() - db.daily > 86400000){ 
            db.bal += 15; 
            db.daily = Date.now(); 
            alert("–ë–æ–Ω—É—Å 15 TON –ø–æ–ª—É—á–µ–Ω!"); 
        } else {
            alert("–ë–æ–Ω—É—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞!");
        }
    }

    // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
    setInterval(update, 1000);
    update();
</script>
